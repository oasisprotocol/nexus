services:
  crdb:
    image: cockroachdb/cockroach:v21.2.10
    ports:
     - 26257:26257
     - 8080:8080
    command: start-single-node --insecure
  oasis-node:
    build:
      context: oasis-node
      dockerfile: ./Dockerfile
    user: oasis
    healthcheck:
      test: oasis-node control status -a unix:/node/data/internal.sock || exit 1
      interval: 5s
      retries: 10
      timeout: 5s
      start_period: 20s
    command:
      - /bin/sh
      - -c
      - oasis-node --config /node/etc/config.yml
    volumes:
      - type: bind
        source: ./node
        target: /node
  indexer:
    build:
      context: ../
      dockerfile: ./docker/indexer/Dockerfile
    depends_on:
      crdb:
        condition: service_started
      oasis-node:
        condition: service_healthy
    command:
      - analyze
      - --analyzer.analysis_config=/config/network.yaml
      - --analyzer.storage_endpoint=postgresql://root@crdb:26257/defaultdb?sslmode=disable
    volumes:
      - type: bind
        source: ./node
        target: /node
      - type: bind
        source: ../storage/migrations
        target: /storage/migrations
volumes:
  go: {}
  migrations: {}
